<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>The EGI v2 guide</title>
        <meta name="robots" content="noindex">


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="toc.js"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">The EGI v2 guide</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="installation"><a class="header" href="#installation">Installation</a></h1>
<h2 id="installing-rust"><a class="header" href="#installing-rust">Installing Rust</a></h2>
<p>EGI v2 is written in <a href="https://www.rust-lang.org/">Rust</a>, so you will need a Rust toolchain installed to compile it.
To check if you do, run the command <code>cargo --help</code> in a terminal.
(<code>cargo</code> is Rust's build tool and package manager.)
You should see output like this:</p>
<pre><code class="language-bash">$ cargo --help
Rust's package manager

Usage: cargo [+toolchain] [OPTIONS] [COMMAND]
       cargo [+toolchain] [OPTIONS] -Zscript &lt;MANIFEST_RS&gt; [ARGS]...
</code></pre>
<p>If so, you can skip the rest of this section.
If not, installing Rust is simple and does not require administrative privileges.
If you are working on a high performance cluster, double check that Rust/cargo aren't already available by loading a module.</p>
<p>To install Rust, use the <code>rustup</code> manager by following the instructions <a href="https://www.rust-lang.org/tools/install">on the rust-lang website</a>.</p>
<h2 id="installing-ggg"><a class="header" href="#installing-ggg">Installing GGG</a></h2>
<p>EGI is a wrapper around the GGG retrieval software, developed at JPL.
You will need GGG installed for EGI to work.
Full instructions to install are given <a href="https://tccon-wiki.caltech.edu/Main/GGG2020ReleaseNotes">on the TCCON wiki</a>.
The very brief version is:</p>
<ol>
<li>Ensure you have a Fortran compiler and the <a href="https://www.anaconda.com/download/"><code>conda</code> package manager</a> installed and available on your system.
The <code>miniconda</code> Python installation provides a minimal Python install and <code>conda</code> manager, and is ideal for this purpose.
<code>gfortran</code> is the default Fortran compiler for GGG; to use another compiler will require you to link the proper compiler script in GGG's <code>install</code> subdirectory.</li>
<li>Download the latest release from https://github.com/TCCON/GGG and untar it.</li>
<li>Set the <code>GGGPATH</code> and <code>gggpath</code> environmental variables for your shell to point to the GGG directory.
These should go in your <code>~/.bashrc</code> or equivalent file.
For example, if <code>/home/user/ggg</code> is the directory that you expanded from the release tarball (it should contain subdirectories such as <code>isotopologs</code> and <code>linelist</code>),
and you use Bash, then add the following to <code>~/.bashrc</code>:</li>
</ol>
<pre><code class="language-bash">export GGGPATH=/home/user/ggg
export gggpath=/home/user/ggg
</code></pre>
<p>If your shell is ZSH, then the syntax is the same, but you would modify <code>~/.zshrc</code> instead.
You can check which shell you have by running the command <code>echo $SHELL</code> in a terminal.</p>
<h2 id="installing-ggg-rs"><a class="header" href="#installing-ggg-rs">Installing GGG-RS</a></h2>
<p>EGI-RS uses some developmental replacements for the GGG post processing programs that have more flexibility to handle
EM27/SUN-specific settings.
Because this is part of a repo still under development, installation is a bit annoying at present.
We will do our best to simplify this in the future.</p>
<p>For now, the following steps will install these programs:</p>
<ol>
<li>Set the environmental variable <code>GGGRS_NCDIR</code> to point to the environment created as part of installing GGG.
Depending on your GGG installation process, this might be at <code>$GGGPATH/install/.condaenv</code> or a named environment
managed by conda. If you do not have a <code>$GGGPATH/install/.condaenv</code>, run <code>conda env list</code> and find the path for
an environment named "ggg-tccon-default".
See the <a href="installation.html#installing-ggg">Installing GGG</a> section above for how to set environmental variables.
After modifying your <code>~/.bashrc</code> or <code>~/.zshrc</code> file, run <code>source ~/.bashrc</code> or <code>source ~/.zshrc</code> to include the
new environmental variable in your shell.</li>
<li>Change directory into your <code>$GGGPATH</code>, directory (<code>cd $GGGPATH</code>)</li>
<li>Clone the GGG-RS repo as <code>src-rs</code> (<code>git clone https://github.com/TCCON/ggg-rs.git src-rs</code>)</li>
<li>Change into the <code>src-rs</code> directory and run the <code>make</code> command.</li>
</ol>
<p>Compilation may take a few minutes.
If all goes well, you should see a message similar to the following:</p>
<pre><code>   Installed package `ggg-rs v0.1.0 (/home/you/ggg/src-rs)` (executables `add_nc_flags`, `apply_tccon_airmass_correction`, `bin2nc`, `change_ggg_files`, `collate_tccon_results`, `i2s_setup`, `list_spectra`, `plot_opus_spectra`, `query_output`, `strip_header`)
warning: be sure to add `/home/you/ggg/bin` to your PATH to be able to run the installed binaries
</code></pre>
<p>You can ignore the warning about adding a directory to your PATH; we will always be calling these programs with their full path, so adding the directory to your PATH (which it so you only need to type the program name to run it).
If you encounter trouble, see the <a href="https://github.com/TCCON/ggg-rs">GGG-RS README</a> for suggestions.
To free up space, you can run the <code>cargo clean</code> command in <code>$GGGPATH/src-rs</code> to delete intermediate compilation files not needed any more.</p>
<h2 id="installing-egi-rs"><a class="header" href="#installing-egi-rs">Installing EGI-RS</a></h2>
<p>Once you have GGG-RS installed, installing EGI-RS is easy.
Simply run the following command from anywhere:</p>
<pre><code class="language-bash">cargo install --git https://github.com/TCCON/egi-rs --root "$GGGPATH"
</code></pre>
<p>Similarly to installing GGG-RS, you should see a message similar to:</p>
<pre><code>   Installed package `egi-rs v0.1.0 (https://github.com/TCCON/egi-rs#2d7a442c)` (executables `em27-catalogue`, `em27-gfit-prep`, `em27-i2s-prep`, `em27-init`)
warning: be sure to add `/home/you/ggg/bin` to your PATH to be able to run the installed binaries
</code></pre>
<p>Again, we can ignore that warning.
The final step is to run the <code>em27-init</code> program we just installed.
This will add some extra EM27/SUN-specific files to your <code>$GGGPATH</code>.
It will print out a summary; all steps should read "OK".
If not, or if you got a fatal error earlier in the run, correct the issue and try again.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="location"><a class="header" href="#location">Location</a></h1>
<p>EGI v2 prefers JSON files to specify the latitude, longitude, and altitude at which the EM27 was positioned.
Unlike version 1, which recommended using coordinate files stored in your <code>EGIPATH</code>, we recommend for version 2
that you place these JSON files alongside your interferograms.
That way, if you package the interferograms to send to another computing system or institution, the necessary
location data goes along with those interferograms.
We do still support the original coordinate file approach, see below for more on that.</p>
<p>For this tutorial, we'll assume that your data will be in a directory structure like this:</p>
<pre><code class="language-text">/
└── data
    └── xx
        ├── 20240401
        │   ├── coords.json
        │   ├── interferograms/
        │   └── met_source.json
        └── 20240402
            ├── coords.json
            ├── interferograms/
            └── met_source.json
</code></pre>
<p>where <code>xx</code> is your site ID. As you can see, the input data is organized by date, and each date has a subfolder containing
the interferograms as well as two JSON files.
We'll create the <code>coords.json</code> files now.
These files can have different formats, but the one we will use here represents a single location.
Since we usually separate our data by day, this format works for all cases where the EM27 was in one location for a given day
(which should be the majority of cases).</p>
<p>These JSON files have the format:</p>
<pre><code class="language-json">{
  "longitude": LONGITUDE_DEG,
  "latitude": LATITUDE_DEG,
  "altitude": ALTITUDE_METERS
}
</code></pre>
<p>where <code>LONGITUDE_DEG</code>, <code>LATITUDE_DEG</code>, and <code>ALTITUDE_METERS</code> must be replaced with numeric values.
EGI uses the convention that west and south are represented as negative values.
Here is a concrete example for an EM27 operated at Caltech, which is at 118.13 W, 34.14 N, and 230 m altitude:</p>
<pre><code class="language-json">
{
  "longitude": -118.13,
  "latitude": 34.14,
  "altitude": 230.0
}
</code></pre>
<p>For this tutorial, we'll assume the EM27 was in the same place for both dates, so we would enter this same information for both files.
If your EM27 is stationed quasi-permanently at one location, you could create one JSON file and symbolically link it to each daily directory.</p>
<p>We will see how these files are used in <a href="./run-i2s.html">Running I2S</a>.</p>
<h2 id="coordinate-file-support"><a class="header" href="#coordinate-file-support">Coordinate file support</a></h2>
<p>If you have coordinate files from EGI v1, you can reuse them by making your <code>coords.json</code> files like so:</p>
<pre><code class="language-json">{
  "site_id": "xx"
}
</code></pre>
<p>Again, "xx" would be replaced with the site ID for these interferograms.
This tells EGI v2 to look for a coordinate file at <code>$EGIPATH/coordinates/xx_dlla.dat</code>.
The coordinate files have the format:</p>
<pre><code class="language-text">2   6
Date     UTCTime   Latitude  Longitude  Alt_masl  Descrip_opt
20140601 01:30:00   35.1431  -116.1042      237    Zzyxx (testing)
20140613 17:34:00   34.1362  -118.1269      237    Caltech
20140613 17:34:32   34.1361  -118.1269      237    CaltechB
20140628 18:55:05   34.1362  -118.1269      237    Caltech
20140628 18:55:30   35.1431  -116.1042      237    Zzyxx (testing)
</code></pre>
<p>where:</p>
<ul>
<li>the first line gives the number of header lines (2) and the number of columns (6) - the number of columns is ignored by EGI v2,</li>
<li>"Date" and "UTCTime" give the starting date/time for these coordinates.
<ul>
<li>"UTCTime" is optional, if omitted.... TODO</li>
</ul>
</li>
<li>"Latitude" and "Longitude" give the coordinates, with south and west represented as negative,</li>
<li>"Alt_masl" is the meters above sea level for this measurement, and</li>
<li>"Descrip_opt" is an optional, human-readable location description (not read by EGI)</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="surface-meteorology"><a class="header" href="#surface-meteorology">Surface meteorology</a></h1>
<p>Surface pressure is required to perform the level 2 retrievals, so it must be available when processing the EM27 interferograms.
Temperature, relative humidity, wind speed, and wind direction are convenient to have, but not required.
Since there is not a standard way of collecting surface meteorology data for EM27 observations, EGI must be flexible in how it accepts this data.</p>
<p><strong>Note:</strong> users are discouraged from using surface pressure from reanalysis meteorology for their surface pressure unless <em>absolutely</em> necessary.
Surface pressure is needed to accurately calculate the position of the EM27 relative to the atmosphere above it, so a good quality measured surface pressure
will give better results.</p>
<p>Continuing with our tutorial, recall the directory structure:</p>
<pre><code class="language-text">/
└── data
    └── xx
        ├── 20240401
        │   ├── coords.json
        │   ├── interferograms/
        │   └── met_source.json
        └── 20240402
            ├── coords.json
            ├── interferograms/
            └── met_source.json
</code></pre>
<p>Now we are going to create the <code>met_source.json</code> files.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="running-i2s"><a class="header" href="#running-i2s">Running i2s</a></h1>
<p>Now that all of the original data is prepared, it's time to set up and run I2S, which converts the interferograms into spectra.
We use the <code>em27-i2s-prep</code> program to set up run directories and scripts for I2S.
This has several subcommands which are useful in different cases.
For this example, we'll use the <code>daily-json</code> subcommand.
This allows us to set up to run each day's worth of interferograms in parallel, with the configuration we need for that included in (yet another) JSON file.</p>
<p>First we need to prepare the JSON file.
It needs to include a number of pieces of information:</p>
<ul>
<li>the directories where the interferograms are stored,</li>
<li>a glob pattern to select the interferograms in each directory,</li>
<li>the paths to the coordinate and meteorology JSON files, and</li>
<li>where we want the run directories to be created.</li>
</ul>
<p>Continuing on from the previous example, let's assume that we're processing data for the instrument with site ID "xx", and we have a directory structure like so:</p>
<pre><code class="language-text">/
└── data
    └── xx
        ├── 20240401
        │   ├── coords.json
        │   ├── interferograms/
        │   └── met_source.json
        └── 20240402
            ├── coords.json
            ├── interferograms/
            └── met_source.json
</code></pre>
<p>We'll also assume that our interferograms include the date in their name,
that we want to create run directories like <code>/data/xx/spectra/20240401</code> to run I2S in,
and that our EM27 has the dual InGaAs detector that supports retrieving CO.
Let's create a JSON file named <code>demo.json</code> with the following contents:</p>
<pre><code class="language-json">{
  "igram_pattern": "/data/{SITE_ID}/{DATE:%Y%m%d}/interferograms/",
  "igram_glob_pattern": "*{DATE:%Y%m%d}*",
  "coord_file_pattern": "/data/{SITE_ID}/{DATE:%Y%m%d}/coords.json",
  "met_file_pattern": "/data/{SITE_ID}/{DATE:%Y%m%d}/met_source.json",
  "run_dir_pattern": "/data/{SITE_ID}/spectra/{DATE:%Y%m%d}"
}
</code></pre>
<p>Notice that our values have some parts in curly braces, namely <code>{SITE_ID}</code> and <code>{DATE:%Y%m%d}</code>.
These are <em>placeholders</em>, which will have the actual value substituted in for each date processed.
<code>{SITE_ID}</code> will be replaced with our two-letter site ID, <code>xx</code>, when we pass it on the command line.
<code>{DATE}</code> will be replaced with each date that we want to process.
The <code>{DATE}</code> placeholders also include an extra part, the <code>:%Y%m%d</code>.
This specifies the format the date should have; "%Y" means the 4-digit year, "%m" the 2-digit month, and "%d" the 2-digit day.
We use the <code>chrono</code> crate for dates, so all the format specifiers listed <a href="https://docs.rs/chrono/latest/chrono/format/strftime/index.html">on their strftime page</a> can be used.
Other characters can be included as well, e.g. <code>%Y.%m.%d</code> would print "2024.04.01" for 1 Apr 2024.
With no format, <code>{DATE}</code> defaults to <code>%Y-%m-%d</code> format.</p>
<p>Now we can run <code>em27-i2s-prep</code> to create our run directories.
Assuming we want to run the 1st, 2nd, and 3rd of Apr 2024, the command is:</p>
<pre><code class="language-bash">$ em27-i2s-prep daily-json demo.json xx 2024-04-01 2024-04-03
</code></pre>
<p>Note that the start and end dates <em>must</em> be given in the YYYY-MM-DD, a.k.a. %Y-%m-%d format for command line arguments.
This may take a minute or two to run (it inspects the headers of every interferogram, which adds up with a lot of them), but will create:</p>
<ul>
<li>three run directories: <code>20240401</code>, <code>20240402</code>, and <code>20240403</code> in <code>/data/xx/spectra</code>, and</li>
<li>a <code>multii2s.sh</code> file in your current directory.</li>
</ul>
<p>The <code>multii2s.sh</code> file is a script that will run each day's interferograms through I2S.
It can be run in serial with <code>bash multii2s.sh</code>, but if your system has the <a href="https://doi.org/10.5281/zenodo.1146014"><code>parallel</code> tool</a>, we can run the days in parallel with the command:</p>
<pre><code class="language-bash">$ parallel -t --delay=1 -j4 &lt; multii2s.sh
</code></pre>
<p>The <code>-j</code> argument specifies how many concurrent tasks to run, here we use 4, but you can use more or less (depending on your system).
Note that, if you are working over an SSH connection, it may be a good idea to run this command in something like <a href="https://www.gnu.org/software/screen/">screen</a>
so that you can disconnect and let it keep running.
Depending on the number of days and interferograms per day, this step could take minutes or a few hours.
When it completes, you will have spectra in each of the run directories.</p>
<p>Now we're ready to run the level 2 retrieval.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="troublshooting-interferogram-conversion"><a class="header" href="#troublshooting-interferogram-conversion">Troublshooting interferogram conversion</a></h1>
<p>This section describes common or difficult-to-understand errors that can occur while setting up to run I2S.</p>
<h2 id="errors-during-preparation"><a class="header" href="#errors-during-preparation">Errors during preparation</a></h2>
<p><strong>What does the error "data did not match any variant of untagged enum CoordinateSource" mean when running em27-i2s-prep?</strong></p>
<p>This means that your <a href="./igm-coords.html">coordinate file</a> did not match any of the expected formats.
That might mean you are missing one of the required fields (or misspelled one), or that a value is not of the proper type.
For instance, if any of "longitude", "latitude", or "altitude" are strings or <code>null</code>, that will cause this error.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->


                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">

            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->

        <script>
        window.addEventListener('load', function() {
            window.setTimeout(window.print, 100);
        });
        </script>

    </div>
    </body>
</html>
